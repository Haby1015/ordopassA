<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard M√©decin - OrdoPass</title>
  <link rel="stylesheet" href="style.css" /> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="dashboard-page">

  <!-- ‚úÖ SIDEBAR -->
  <aside class="sidebar">
    <div class="logo"><i class="fa-solid fa-notes-medical"></i> ORDOPASS</div>
    <nav>
      <a href="medecin_dashboard.html" class="active"><i class="fa-solid fa-file-medical"></i> Consultations</a>
      <a href="patients.html"><i class="fa-solid fa-users"></i> Patients</a>
      <a href="teleconsultation.html"><i class="fa-solid fa-video"></i> T√©l√©consultation</a>
      <a href="pharmacies.html"><i class="fa-solid fa-prescription-bottle-medical"></i> Pharmacies</a>
      <a href="medecin_messagerie.html"><i class="fa-solid fa-comment-medical"></i> Messagerie</a>
      <a href="parametres.html"><i class="fa-solid fa-gear"></i> Param√®tres</a>
      <a href="medecin_facturation.html"><i class="fa-solid fa-file-invoice-dollar"></i> Facturation</a>
      <a href="medecin_rendezvous.html"><i class="fa-solid fa-calendar-check"></i> Rendez-vous</a>
      <a href="medecin_ordonnance.html"><i class="fa-solid fa-prescription"></i> Ordonnances s√©curis√©es</a>
      <a href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i> D√©connexion</a>
    </nav>
  </aside>

  <!-- ‚úÖ CONTENU PRINCIPAL -->
  <main class="main-area">
    <header class="topbar">
      <h1><i class="fa-solid fa-file-medical"></i> Liste des consultations</h1>
      <div class="user-info">
        <img src="https://i.pravatar.cc/40" class="avatar" alt="profil">
        <span id="usernameDisplay"></span>
      </div>
    </header>

    <section class="content">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom:20px;">
          <h2>Consultations</h2>
          <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn-outline" onclick="createTestData()" id="testDataBtn">
              <i class="fa-solid fa-database"></i> Donn√©es Test
            </button>
            <a href="#" class="btn-outline"><i class="fa-solid fa-video"></i> T√©l√©consultation</a>
            <a href="nouvelle_consultation.html" class="btn-primary" style="text-decoration:none; display:inline-flex; align-items:center; gap:5px;">
              <i class="fa-solid fa-plus"></i> Nouvelle consultation
            </a>
          </div>
        </div>

        <div id="messageContainer"></div>

        <table>
          <thead>
            <tr>
              <th>No ticket</th>
              <th>Nom du patient</th>
              <th>Image</th>
              <th>Date/heure</th>
              <th>Motif</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="consultationsBody">
            <tr>
              <td colspan="7" class="loading">
                <i class="fa-solid fa-spinner fa-spin"></i> Chargement des consultations...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- ‚úÖ JAVASCRIPT -->
  <script>
    // === S√âCURIT√â : Redirection si non connect√© ===
    const user = JSON.parse(localStorage.getItem("currentUser"));
    if (!user || user.role !== "medecin") {
      alert("‚ö†Ô∏è Acc√®s refus√©. Veuillez vous connecter.");
      window.location.href = "index.html";
    }

    // === Affichage du nom de l'utilisateur ===
    document.getElementById("usernameDisplay").textContent = user.username;

    // === Fonction d'affichage de messages ===
    function showMessage(message, type = 'info') {
      const container = document.getElementById('messageContainer');
      container.innerHTML = `
        <div class="${type}" style="padding:15px; border-radius:5px; margin-bottom:15px; 
          background: ${type === 'error' ? '#f8d7da' : type === 'success' ? '#d4edda' : '#d1ecf1'};
          color: ${type === 'error' ? '#721c24' : type === 'success' ? '#155724' : '#0c5460'};
          border: 1px solid ${type === 'error' ? '#f5c6cb' : type === 'success' ? '#c3e6cb' : '#bee5eb'};">
          ${message}
        </div>
      `;
      setTimeout(() => { container.innerHTML = ''; }, 5000);
    }

    // === Cr√©er des donn√©es de test ===
    async function createTestData() {
      const btn = document.getElementById('testDataBtn');
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Cr√©ation...';
      btn.disabled = true;

      try {
        const response = await fetch('/api/test-data', { method: 'POST' });
        const result = await response.json();
        
        if (response.ok) {
          showMessage(`‚úÖ ${result.message} - ${result.consultations} consultations cr√©√©es`, 'success');
          loadConsultations();
        } else {
          showMessage(`‚ùå ${result.error}`, 'error');
        }
      } catch (error) {
        console.error('Erreur:', error);
        showMessage('‚ùå Erreur de connexion au serveur', 'error');
      } finally {
        btn.innerHTML = '<i class="fa-solid fa-database"></i> Donn√©es Test';
        btn.disabled = false;
      }
    }

    // === Charger les consultations ===
    async function loadConsultations() {
      try {
        const response = await fetch('/api/consultations');
        if (response.ok) {
          const consultations = await response.json();
          renderConsultations(consultations);
        }
      } catch (error) {
        console.error(error);
      }
    }

    // === Afficher les consultations ===
    function renderConsultations(consultations) {
      const tbody = document.getElementById("consultationsBody");
      tbody.innerHTML = "";

      consultations.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>#${c.ticket || 'N/A'}</td>
          <td><strong>${c.nom || ''} ${c.prenom || ''}</strong></td>
          <td><img src="${c.image || 'https://i.pravatar.cc/40'}" alt="${c.nom}" class="avatar"></td>
          <td>${c.date || 'N/A'} ${c.heure ? '| ' + c.heure : ''}</td>
          <td>${c.motif || 'Non sp√©cifi√©'}</td>
          <td><span class="status ${c.statut==="Termin√©"?"done":"pending"}">${c.statut || 'En attente'}</span></td>
          <td>
            <button class="btn-outline viewBtn" data-id="${c._id}">
              <i class="fa-solid fa-eye"></i> Voir
            </button>
            <button class="btn-outline editBtn" data-id="${c._id}">
              <i class="fa-solid fa-pen"></i>
            </button>
            <button class="btn-outline deleteBtn" data-id="${c._id}">
              <i class="fa-solid fa-trash"></i>
            </button>
          </td>
        `;

        tr.querySelector(".viewBtn").addEventListener("click", function() {
          const consultationId = this.getAttribute('data-id');
          window.location.href = `consultation_detail.html?id=${consultationId}`;
        });

        tr.querySelector(".deleteBtn").addEventListener("click", async function() {
          const consultationId = this.getAttribute('data-id');
          if(confirm("Voulez-vous vraiment supprimer cette consultation ?")){
            try {
              const response = await fetch(`/api/consultations/${consultationId}`, {
                method: 'DELETE'
              });
              if (response.ok) {
                showMessage('‚úÖ Consultation supprim√©e avec succ√®s', 'success');
                loadConsultations();
              } else {
                showMessage('‚ùå Erreur lors de la suppression', 'error');
              }
            } catch (error) {
              console.error('Erreur:', error);
              showMessage('‚ùå Erreur lors de la suppression', 'error');
            }
          }
        });

        tr.querySelector(".editBtn").addEventListener("click", function() {
          const consultationId = this.getAttribute('data-id');
          window.location.href = `consultation_detail.html?id=${consultationId}`;
        });

        tbody.appendChild(tr);
      });
    }

    // === D√©connexion ===
    document.getElementById("logout").addEventListener("click", function(e) {
      e.preventDefault();
      localStorage.removeItem("currentUser");
      alert("üëã Vous avez √©t√© d√©connect√© avec succ√®s.");
      window.location.href = "index.html"; // ‚úÖ Redirection vers la page d'accueil
    });

    // === Chargement initial ===
    document.addEventListener('DOMContentLoaded', function() {
      loadConsultations();
    });
  </script>
</body>
</html>
