<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Détail Consultation - OrdoPass</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; }
    .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; }
    .status.done { color:green; font-weight:bold; }
    .status.pending { color:orange; font-weight:bold; }
    .btn-outline { border:1px solid #2a5298; color:#2a5298; padding:8px 15px; border-radius:5px; cursor:pointer; background:#fff; }
    .btn-primary { background:#2a5298; color:#fff; padding:8px 15px; border:none; border-radius:5px; cursor:pointer; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
    .modal-content { background:#fff; padding:25px; border-radius:8px; width:90%; max-width:600px; max-height:90vh; overflow-y:auto; }
    .modal-content input, .modal-content select, .modal-content textarea { width:100%; padding:10px; margin-bottom:15px; box-sizing:border-box; border:1px solid #ddd; border-radius:5px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { padding:12px; text-align:left; border-bottom:1px solid #ccc; }
    
    /* Styles spécifiques pour le détail consultation */
    .consultation-detail { background:white; padding:25px; border-radius:8px; margin:20px 0; }
    .detail-section { margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid #eee; }
    .detail-section h3 { color:#2a5298; margin-bottom:15px; }
    .patient-info { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:15px; margin-bottom:20px; }
    .info-item { margin-bottom:15px; }
    .info-label { font-weight:bold; color:#555; margin-bottom:5px; }
    .info-value { padding:10px; background:#f9f9f9; border-radius:5px; border-left:3px solid #2a5298; }
    .symptoms-text, .exam-text { background:#f9f9f9; padding:15px; border-radius:5px; border-left:3px solid #2a5298; line-height:1.6; white-space:pre-wrap; }
    .analysis-list { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    .analysis-tag { background:#e9ecef; padding:5px 12px; border-radius:15px; font-size:0.9rem; }
    .medication-item, .facture-item { 
      background:#f9f9f9; border:1px solid #eee; border-radius:5px; padding:15px; margin-bottom:10px; 
    }
    .item-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .action-buttons { display:flex; gap:10px; margin-top:25px; flex-wrap:wrap; }
    .add-section { 
      background:#f8f9fa; border:2px dashed #dee2e6; border-radius:5px; padding:20px; text-align:center; 
      margin:15px 0; cursor:pointer; transition:all 0.3s;
    }
    .add-section:hover { border-color:#2a5298; background:#e9ecef; }
    .remove-btn { background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer; font-size:0.8rem; }
  </style>
</head>
<body class="dashboard-page">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo"><i class="fa-solid fa-notes-medical"></i> ORDOPASS</div>
    <nav>
      <a href="medecin_dashboard.html"><i class="fa-solid fa-file-medical"></i> Consultations</a>
      <a href="patients.html"><i class="fa-solid fa-users"></i> Patients</a>
      <a href="teleconsultation.html"><i class="fa-solid fa-video"></i> Téléconsultation</a>
      <a href="pharmacies.html"><i class="fa-solid fa-prescription-bottle-medical"></i> Pharmacies</a>
      <a href="medecin_messagerie.html"><i class="fa-solid fa-comment-medical"></i> Messagerie</a>
      <a href="parametres.html"><i class="fa-solid fa-gear"></i> Paramètres</a>
      <a href="medecin_facturation.html"><i class="fa-solid fa-file-invoice-dollar"></i> Facturation</a>
      <a href="medecin_rendezvous.html"><i class="fa-solid fa-calendar-check"></i> Rendez-vous</a>
      <a href="medecin_ordonnance.html"><i class="fa-solid fa-prescription"></i> Ordonnances sécurisées</a>
      <a href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i> Déconnexion</a>
    </nav>
  </aside>

  <!-- Contenu -->
  <main class="main-area">
    <header class="topbar">
      <h1><i class="fa-solid fa-file-medical"></i> Détails de la consultation</h1>
      <div class="user-info">
        <img src="https://i.pravatar.cc/40" class="avatar" alt="profil">
        <span id="usernameDisplay"></span>
      </div>
    </header>

    <section class="content">
      <div class="card">
        <div class="consultation-detail">
          <!-- Patient Info -->
          <div class="detail-section">
            <h3>Informations patient</h3>
            <div class="patient-info">
              <div class="info-item">
                <div class="info-label">Numéro de ticket</div>
                <div class="info-value" id="ticketNumber">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Nom du patient</div>
                <div class="info-value" id="patientName">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Date et heure</div>
                <div class="info-value" id="consultationDateTime">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Médecin traitant</div>
                <div class="info-value">Dr Fatoumata Ndiaye</div>
              </div>
              <div class="info-item">
                <div class="info-label">Statut</div>
                <div class="info-value">
                  <span id="consultationStatus">-</span>
                </div>
              </div>
              <div class="info-item">
                <div class="info-label">Motif</div>
                <div class="info-value" id="consultationMotif">-</div>
              </div>
            </div>
          </div>

          <!-- Symptoms -->
          <div class="detail-section">
            <h3>Symptômes</h3>
            <div class="symptoms-text" id="symptomsText">
              Aucun symptôme renseigné.
            </div>
          </div>

          <!-- Analyses -->
          <div class="detail-section">
            <h3>Analyses médicales</h3>
            <div class="analysis-list" id="analysesList">
              <!-- Les analyses seront ajoutées ici dynamiquement -->
            </div>
            <div class="add-section" onclick="openAddAnalysisModal()">
              <i class="fa-solid fa-plus" style="font-size:1.5rem; color:#2a5298; margin-bottom:10px;"></i>
              <div>Ajouter une analyse</div>
            </div>
          </div>

          <!-- Examens -->
          <div class="detail-section">
            <h3>Examens physiques</h3>
            <div class="exam-text" id="examText">
              Aucun examen renseigné.
            </div>
            <div class="add-section" onclick="openEditExamModal()">
              <i class="fa-solid fa-edit" style="font-size:1.5rem; color:#2a5298; margin-bottom:10px;"></i>
              <div>Modifier les examens</div>
            </div>
          </div>

          <!-- Ordonnances -->
          <div class="detail-section">
            <h3>Ordonnances</h3>
            <div id="ordonnancesList">
              <!-- Les ordonnances seront ajoutées ici dynamiquement -->
            </div>
            <div class="add-section" onclick="openAddOrdonnanceModal()">
              <i class="fa-solid fa-prescription" style="font-size:1.5rem; color:#2a5298; margin-bottom:10px;"></i>
              <div>Ajouter une ordonnance</div>
            </div>
          </div>

          <!-- Factures -->
          <div class="detail-section">
            <h3>Facturation</h3>
            <div id="facturesList">
              <!-- Les factures seront ajoutées ici dynamiquement -->
            </div>
            <div class="add-section" onclick="openAddFactureModal()">
              <i class="fa-solid fa-file-invoice-dollar" style="font-size:1.5rem; color:#2a5298; margin-bottom:10px;"></i>
              <div>Ajouter une facture</div>
            </div>
          </div>

          <!-- Boutons d'action -->
          <div class="action-buttons">
            <button class="btn-primary" onclick="saveConsultation()">
              <i class="fa-solid fa-floppy-disk"></i> Sauvegarder
            </button>
            <button class="btn-outline" onclick="printConsultation()">
              <i class="fa-solid fa-print"></i> Imprimer
            </button>
            <button class="btn-outline" onclick="goBack()">
              <i class="fa-solid fa-arrow-left"></i> Retour
            </button>
            <button class="btn-outline" style="margin-left:auto; color:#dc3545; border-color:#dc3545;" onclick="cancelConsultation()">
              <i class="fa-solid fa-times"></i> Annuler la consultation
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modals -->
  <div id="addAnalysisModal" class="modal">
    <div class="modal-content">
      <h3>Ajouter une analyse</h3>
      <input type="text" id="newAnalysisName" placeholder="Nom de l'analyse">
      <textarea id="newAnalysisDescription" placeholder="Description de l'analyse"></textarea>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn-outline" onclick="closeAddAnalysisModal()">Annuler</button>
        <button class="btn-primary" onclick="saveAnalysis()">Enregistrer</button>
      </div>
    </div>
  </div>

  <div id="editExamModal" class="modal">
    <div class="modal-content">
      <h3>Modifier les examens</h3>
      <textarea id="editExamText" placeholder="Résultats des examens physiques..."></textarea>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn-outline" onclick="closeEditExamModal()">Annuler</button>
        <button class="btn-primary" onclick="saveExam()">Enregistrer</button>
      </div>
    </div>
  </div>

  <div id="addOrdonnanceModal" class="modal">
    <div class="modal-content">
      <h3>Ajouter une ordonnance</h3>
      <input type="text" id="ordonnanceMedicament" placeholder="Nom du médicament">
      <input type="text" id="ordonnanceDosage" placeholder="Dosage (ex: 500mg)">
      <input type="text" id="ordonnancePosologie" placeholder="Posologie (ex: 1 comprimé matin et soir)">
      <input type="text" id="ordonnanceDuree" placeholder="Durée (ex: 5 jours)">
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn-outline" onclick="closeAddOrdonnanceModal()">Annuler</button>
        <button class="btn-primary" onclick="saveOrdonnance()">Enregistrer</button>
      </div>
    </div>
  </div>

  <div id="addFactureModal" class="modal">
    <div class="modal-content">
      <h3>Ajouter une facture</h3>
      <input type="number" id="factureMontant" placeholder="Montant (FCFA)">
      <select id="factureStatut">
        <option value="En attente">En attente</option>
        <option value="Payé">Payé</option>
        <option value="Partiel">Partiel</option>
      </select>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn-outline" onclick="closeAddFactureModal()">Annuler</button>
        <button class="btn-primary" onclick="saveFacture()">Enregistrer</button>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const consultationId = urlParams.get('id');
    let currentConsultation = null;

    // Charger les données de consultation
    async function loadConsultation() {
      if (!consultationId) {
        console.error("Aucun ID de consultation fourni");
        return;
      }

      try {
        const response = await fetch(`/api/consultations/${consultationId}`);
        if (response.ok) {
          currentConsultation = await response.json();
          displayConsultationData();
        } else {
          console.error("Erreur lors du chargement de la consultation");
        }
      } catch (error) {
        console.error("Erreur:", error);
      }
    }

    // Afficher les données de consultation
    function displayConsultationData() {
      if (!currentConsultation) return;

      document.getElementById('ticketNumber').textContent = currentConsultation.ticket || '-';
      document.getElementById('patientName').textContent = `${currentConsultation.nom || ''} ${currentConsultation.prenom || ''}`.trim() || 'Non spécifié';
      document.getElementById('consultationDateTime').textContent = 
        `${currentConsultation.date || 'N/A'} | ${currentConsultation.heure || ''}`;
      document.getElementById('consultationMotif').textContent = currentConsultation.motif || '-';
      
      // Statut avec style
      const statusElement = document.getElementById('consultationStatus');
      statusElement.textContent = currentConsultation.statut || 'En cours';
      statusElement.className = currentConsultation.statut === 'Terminé' ? 'status done' : 'status pending';
      
      document.getElementById('symptomsText').textContent = currentConsultation.symptomes || 'Aucun symptôme renseigné.';
      
      // Afficher les analyses
      const analysesList = document.getElementById('analysesList');
      analysesList.innerHTML = '';
      if (currentConsultation.analyses && currentConsultation.analyses.length > 0) {
        currentConsultation.analyses.forEach(analysis => {
          const tag = document.createElement('span');
          tag.className = 'analysis-tag';
          tag.textContent = analysis;
          analysesList.appendChild(tag);
        });
      } else {
        analysesList.innerHTML = '<p style="color:#777;">Aucune analyse prescrite</p>';
      }

      // Afficher les examens
      document.getElementById('examText').textContent = 
        currentConsultation.examens && currentConsultation.examens.length > 0 
          ? currentConsultation.examens.join('\n') 
          : 'Aucun examen renseigné.';

      // Afficher les ordonnances
      displayOrdonnances();
      
      // Afficher les factures
      displayFactures();
    }

    function displayOrdonnances() {
      const container = document.getElementById('ordonnancesList');
      container.innerHTML = '';

      if (currentConsultation.ordonnances && currentConsultation.ordonnances.length > 0) {
        currentConsultation.ordonnances.forEach(ordonnance => {
          const item = document.createElement('div');
          item.className = 'medication-item';
          item.innerHTML = `
            <div class="item-header">
              <strong>Ordonnance du ${new Date(ordonnance.date).toLocaleDateString('fr-FR')}</strong>
              <button class="remove-btn" onclick="deleteOrdonnance('${ordonnance._id}')">
                <i class="fa-solid fa-trash"></i> Supprimer
              </button>
            </div>
            <div>${ordonnance.contenu || 'Aucun détail'}</div>
          `;
          container.appendChild(item);
        });
      } else {
        container.innerHTML = '<p style="color:#777; text-align:center;">Aucune ordonnance créée</p>';
      }
    }

    function displayFactures() {
      const container = document.getElementById('facturesList');
      container.innerHTML = '';

      if (currentConsultation.factures && currentConsultation.factures.length > 0) {
        currentConsultation.factures.forEach(facture => {
          const item = document.createElement('div');
          item.className = 'facture-item';
          item.innerHTML = `
            <div class="item-header">
              <strong>Facture du ${new Date(facture.date).toLocaleDateString('fr-FR')}</strong>
              <button class="remove-btn" onclick="deleteFacture('${facture._id}')">
                <i class="fa-solid fa-trash"></i> Supprimer
              </button>
            </div>
            <div>Montant: ${facture.montant} FCFA</div>
            <div>Statut: ${facture.statut}</div>
          `;
          container.appendChild(item);
        });
      } else {
        container.innerHTML = '<p style="color:#777; text-align:center;">Aucune facture créée</p>';
      }
    }

    // Fonctions pour les modals
    function openAddAnalysisModal() {
      document.getElementById('addAnalysisModal').style.display = 'flex';
    }

    function closeAddAnalysisModal() {
      document.getElementById('addAnalysisModal').style.display = 'none';
      document.getElementById('newAnalysisName').value = '';
      document.getElementById('newAnalysisDescription').value = '';
    }

    function openEditExamModal() {
      document.getElementById('editExamModal').style.display = 'flex';
      document.getElementById('editExamText').value = currentConsultation.examens ? currentConsultation.examens.join('\n') : '';
    }

    function closeEditExamModal() {
      document.getElementById('editExamModal').style.display = 'none';
    }

    function openAddOrdonnanceModal() {
      document.getElementById('addOrdonnanceModal').style.display = 'flex';
    }

    function closeAddOrdonnanceModal() {
      document.getElementById('addOrdonnanceModal').style.display = 'none';
      document.getElementById('ordonnanceMedicament').value = '';
      document.getElementById('ordonnanceDosage').value = '';
      document.getElementById('ordonnancePosologie').value = '';
      document.getElementById('ordonnanceDuree').value = '';
    }

    function openAddFactureModal() {
      document.getElementById('addFactureModal').style.display = 'flex';
    }

    function closeAddFactureModal() {
      document.getElementById('addFactureModal').style.display = 'none';
      document.getElementById('factureMontant').value = '';
      document.getElementById('factureStatut').value = 'En attente';
    }

    // Sauvegarder les données
    async function saveAnalysis() {
      const name = document.getElementById('newAnalysisName').value;
      const description = document.getElementById('newAnalysisDescription').value;
      
      if (!name) {
        alert('Veuillez saisir un nom pour l\'analyse');
        return;
      }

      try {
        const updatedAnalyses = [...(currentConsultation.analyses || []), name];
        const response = await fetch(`/api/consultations/${consultationId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ analyses: updatedAnalyses })
        });

        if (response.ok) {
          closeAddAnalysisModal();
          loadConsultation(); // Recharger les données
        }
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la sauvegarde');
      }
    }

    async function saveExam() {
      const examText = document.getElementById('editExamText').value;
      
      try {
        const response = await fetch(`/api/consultations/${consultationId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ examens: [examText] })
        });

        if (response.ok) {
          closeEditExamModal();
          loadConsultation();
        }
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la sauvegarde');
      }
    }

    async function saveOrdonnance() {
      const medicament = document.getElementById('ordonnanceMedicament').value;
      const dosage = document.getElementById('ordonnanceDosage').value;
      const posologie = document.getElementById('ordonnancePosologie').value;
      const duree = document.getElementById('ordonnanceDuree').value;

      if (!medicament || !dosage || !posologie || !duree) {
        alert('Veuillez remplir tous les champs');
        return;
      }

      const contenu = `${medicament} - ${dosage}\nPosologie: ${posologie}\nDurée: ${duree}`;

      try {
        const response = await fetch(`/api/consultations/${consultationId}/ordonnances`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contenu })
        });

        if (response.ok) {
          closeAddOrdonnanceModal();
          loadConsultation();
        }
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la création de l\'ordonnance');
      }
    }

    async function saveFacture() {
      const montant = document.getElementById('factureMontant').value;
      const statut = document.getElementById('factureStatut').value;

      if (!montant) {
        alert('Veuillez saisir un montant');
        return;
      }

      try {
        const response = await fetch(`/api/consultations/${consultationId}/factures`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ montant: parseFloat(montant), statut })
        });

        if (response.ok) {
          closeAddFactureModal();
          loadConsultation();
        }
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la création de la facture');
      }
    }

    // Supprimer ordonnance/facture
    async function deleteOrdonnance(ordonnanceId) {
      if (confirm('Voulez-vous vraiment supprimer cette ordonnance ?')) {
        // Implémentez la suppression d'ordonnance selon votre API
        alert('Fonction de suppression à implémenter');
      }
    }

    async function deleteFacture(factureId) {
      if (confirm('Voulez-vous vraiment supprimer cette facture ?')) {
        // Implémentez la suppression de facture selon votre API
        alert('Fonction de suppression à implémenter');
      }
    }

    // Autres fonctions
    function saveConsultation() {
      alert('Consultation sauvegardée avec succès');
    }

    function printConsultation() {
      window.print();
    }

    function goBack() {
      window.history.back();
    }

    function cancelConsultation() {
      if (confirm('Voulez-vous vraiment annuler cette consultation ?')) {
        window.location.href = 'medecin_dashboard.html';
      }
    }

    // Déconnexion
    document.getElementById('logout').addEventListener('click', function(e) {
      e.preventDefault();
      localStorage.removeItem('currentUser');
      window.location.href = 'login.html';
    });

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
      const user = JSON.parse(localStorage.getItem('currentUser')) || { username: 'Médecin' };
      document.getElementById('usernameDisplay').textContent = user.username;
      
      loadConsultation();
    });
  </script>
</body>
</html>